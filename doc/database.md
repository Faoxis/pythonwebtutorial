# Подключаем базу данных

На этом шаге мы узнаем как подключить базу данных через ORM Orator, как создавать и редактировать изменения в ней и многое другое.
Подразумевается, что СУБД `PostgreSQL` уже стоит на компьютере.
<hr>



### Поготовка базы данных
* Для того, чтобы начать работу с базой данных, было бы не плохо создать ее.
* Для начала входим в командный режим СУБД:
```
$ psql -U postgres
```
* Пользовать `postgres` создается автоматически при установке СУБД.
* Система запросит пароль, который надо было вводить при установке `PostgreSQL`. Делаем это.
* Пусть наша БД называет `pwtutorial`, создадим ее:
 ```
 # CREATE DATABASE pwtutorial;
 ```
* Отлично! Теперь у нас есть база данных, в которой можно создавать нужные нам таблицы! Сделаем это.
* Для этого перейдем в командной строке в специальный режим управления базой данных:
```
# \c pwtutorial
```
* Если все сделано правильно, то слева от строки ввода будет название базы данных. Создадим таблицу `task`:
```
# CREATE TABLE task (id SERIAL, name VARCHAR(100), created_at TIMESTAMP, PRIMARY KEY (id));
```
* Замечатльно! Теперь у нас есть база данных для хранения списка задач.
* Добавим в нее тестовые данные:
```
# INSERT INTO task(name, created_at) values ('Writing tutorial', NOW());
# INSERT INTO task(name, created_at) values ('another awesome task', NOW());
```
* Проверить наличие добавленных задач можно следующим образом:
```
# select * from task;
```



### Настройка соединения с базой данных
* Для начала необходимо установить драйвер работы с `postgreSQL` и занести эту зависимость в `requirement.txt`. Выполняем из папки с проектом:
```
venv/bin/pip install psycopg2
echo psycopg2 >> requirements.txt
```
* Создадим в папке `config` файл `database.yaml` в котором укажем все необходимые настройки согласно `yaml`-формату.
* Файл `config/database.yaml` следует пометить для `git` как неотслеживаемый, т.к. в нем содержится пароль и логин к нашей БД.
* Создадим файл в папке `config` с таким же названием, но в конце добавим `.sample`. Если кто-то захочет воспользоваться нашим приложением он просто посмотрит на данный пример с конфигурацией.
* Если возникают сложности с настройкой, то можно глянуть пример настроек [здесь](../config/database.yaml.sample)


### Создаем соединение
* Установка настроек базы данных является неотемлемой частью моделирования нашей задачи, поэтому необходимо провести их при инициализации моделей.
* Для этого создаем файл `app/model/__init__.py` и пихаем в него настройки подключения:
```python
# Импорт библиотеки для парсинга yaml-файлов
import yaml
# Импорт необходимых классов из пакета orator
from orator import DatabaseManager, Model

# Парсинг конфигураций базы данных
with open('config/database.yaml') as file:
    config = yaml.load(file.read())

# Создаем объекта класса DatabaseManager со всеми необходимыми конфигурациями
db = DatabaseManager(config)

# И устанавливаем его в классе Model
Model.set_connection_resolver(db)
```


### Создание модели таблицы
* Для удобства работы с базой данных часто таблицы "оборачивают" в классы. Это и есть основная цель любой `ORM (object relation mapping)`.
* Поэтому в папке `model` создадим файл `task.py` и наполним его следующим содержимым:
```python
# Импорт модели
from orator import Model

# Создание представления таблицы в виде класса
class Task(Model):
    # Указываем на какую таблицу будет ссылаться модель
    __table__ = 'task'
```

### Проверка работы
* Для того, чтобы проверить работоспособность нашей модели наполним модуль запуска приложения `run.py` таким содержимым:
```python
# Импортируем наш модуль
from app.model.task import Task

# Просим достать из таблицы все записи
tasks = Task.select().get()

# Перебираем записи и если выводим на печать поле name для каждого кортежа
for task in tasks:
    print(task.name)
```
* В моему случае результат вывода такой:
```
Writing tutorial
another awesome task
```
* Отлично! Это означает, что база данных подключена и все работает.


### Если что-то не получается
1. Можно скачать мой точно работающий проект и проверенный проект и посмотреть чем он отличается.
* Скачать можно простым вводом команды в терминал:
```
git clone https://github.com/Faoxis/pythonwebtutorial.git
```
* После ввода команды в текущей директории появится папка с проектом.
2. Проверить настройки базы данных и корректность в названиях параметров. Для удобства можно вопспользоваться графическим интерфейсом, например, программы `pgAdmin`.
3. Прислать мне ошибку или описать, что не получается.


#### [Назад](../README.md)
